<script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
<script>
let globalPyodide;
let nextOrderId = 0;
let messageQueue = [];

// async function initializePython() {
//     globalPyodide = await loadPyodide();
//     await globalPyodide.loadPackage('micropip');
//     const micropip = globalPyodide.pyimport('micropip');
//     await micropip.install('/tupi-annotation-suite/tupi-0.1.0-py3-none-any.whl');
//     await micropip.install('/tupi-annotation-suite/pydicate-0.1.1-py3-none-any.whl');
//     // globalPyodide.runPython('print(tupi.Noun("îagûar", "normal"))');
//     this.pyodideReady = true;
//     window.parent.postMessage({ pyodideLoaded: true }, '*');
// }
async function initializePython() {
    globalPyodide = await loadPyodide();
    await globalPyodide.loadPackage('micropip');
    const micropip = globalPyodide.pyimport('micropip');
    await micropip.install('https://kiansheik.io/nhe-enga/gramatica/pylibs/tupi-0.1.0-py3-none-any.whl');
    globalPyodide.runPython('import tupi');
    globalPyodide.runPython('print(tupi.Noun(\'îagûar\', \'normal\'))');
    this.pyodideReady = true;
    window.parent.postMessage({ pyodideLoaded: true }, '*');
}

window.addEventListener('message', async (event) => {
    if (event.data.command === 'processBlock') {
        messageQueue.push(event.data);
        messageQueue.sort((a, b) => a.orderid - b.orderid);

        if (messageQueue.length > 0 && nextOrderId > messageQueue[0].orderid) {
            nextOrderId = 0;
        }

        while (messageQueue.length > 0 && messageQueue[0].orderid === nextOrderId) {
            let data = messageQueue.shift();
            const block_text = data.html;
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(block_text, 'text/html');
            const textContent = htmlDoc.body.textContent || '';
            const command = `${textContent}`;

            try {
                const [imports, expression] = command.split(';', 2);
                globalPyodide.runPython(imports);

                let result;
                try {
                    result = globalPyodide.runPython(expression.trim());
                } catch (evalError) {
                    result = `ERROR: ${evalError}`;
                }

                window.parent.postMessage({
                    command: "processBlockResponse",
                    pre_html: block_text,
                    resp_html: result !== undefined ? result.toString() : '',
                    hash: data.hash
                }, '*');
            } catch (error) {
                console.error(error);
                window.parent.postMessage({
                    command: "processBlockResponse",
                    pre_html: block_text,
                    resp_html: `ERROR: ${error.toString()}`,
                    hash: data.hash
                }, '*');
            }

            nextOrderId++;
        }
    }
});

initializePython();
</script>
